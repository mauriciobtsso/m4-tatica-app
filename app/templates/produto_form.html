{% extends "base.html" %}

{% block title %}{% if produto %}Editar Produto{% else %}Precificar Novo Produto{% endif %} - M4 Tática{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">{% if produto %}Editar Produto: {{ produto.nome }}{% else %}Precificar Novo Produto{% endif %}</h1>
        <a href="{{ url_for('main.produtos') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Voltar para a Lista
        </a>
    </div>

    <form method="POST" id="precificador-form">
        <div class="row">
            <div class="col-lg-7">
                <div class="card mb-4">
                    <div class="card-header fw-bold">
                        Informações de Custo
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="codigo" class="form-label">SKU:</label>
                                <input type="text" class="form-control" id="codigo" name="codigo" value="{{ produto.codigo if produto else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome do Produto:</label>
                                <input type="text" class="form-control" id="nome" name="nome" value="{{ produto.nome if produto else '' }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="valor_fornecedor_real" class="form-label">Valor Fornecedor (R$):</label>
                                <input type="text" class="form-control" id="valor_fornecedor_real" name="valor_fornecedor_real" value="{{ produto.valor_fornecedor_real if produto else '' }}" inputmode="decimal" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="desconto_fornecedor_percentual" class="form-label">Desconto (%):</label>
                                <input type="text" class="form-control" id="desconto_fornecedor_percentual" name="desconto_fornecedor_percentual" value="{{ produto.desconto_fornecedor_percentual if produto else '' }}" inputmode="decimal">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="frete_real" class="form-label">Frete (R$):</label>
                                <input type="text" class="form-control" id="frete_real" name="frete_real" value="{{ produto.frete_real if produto else '' }}" inputmode="decimal">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="difal_percentual" class="form-label">DIFAL (%):</label>
                                <input type="text" class="form-control" id="difal_percentual" name="difal_percentual" value="{{ produto.difal_percentual if produto else '' }}" inputmode="decimal">
                            </div>
                        </div>
                        <div class="row align-items-end">
                             <div class="col-md-6 mb-3">
                                <label for="ipi_valor" class="form-label">Valor IPI:</label>
                                <input type="text" class="form-control" id="ipi_valor" name="ipi_valor" value="{{ produto.ipi_valor if produto else '' }}" inputmode="decimal">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de IPI:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ipi_tipo" id="ipi_fixo" value="fixo" checked>
                                    <label class="form-check-label" for="ipi_fixo">Valor Fixo (R$)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="ipi_tipo" id="ipi_percentual" value="percentual">
                                    <label class="form-check-label" for="ipi_percentual">Percentual Embutido (%)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header fw-bold">
                        Precificação e Impostos de Venda
                    </div>
                    <div class="card-body">
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="imposto_venda_percentual" class="form-label">Imposto de Venda (%):</label>
                                <input type="text" class="form-control percentage" id="imposto_venda_percentual" name="imposto_venda_percentual" value="{{ produto.imposto_venda_percentual if produto else '0.0' }}" inputmode="decimal">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Método de Precificação:</label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="metodo_precificacao" id="margem" value="margem" checked>
                                <label class="form-check-label" for="margem">Margem (%)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="metodo_precificacao" id="lucro_alvo" value="lucro_alvo">
                                <label class="form-check-label" for="lucro_alvo">Lucro Alvo (R$)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="metodo_precificacao" id="preco_final" value="preco_final">
                                <label class="form-check-label" for="preco_final">Preço Final (R$)</label>
                            </div>
                        </div>
                        <div>
                            <label for="valor_metodo" class="form-label">Valor do Método:</label>
                            <input type="text" class="form-control" id="valor_metodo" name="valor_metodo" inputmode="decimal" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card mb-4 position-sticky" style="top: 20px;">
                    <div class="card-header fw-bold">
                        Resultados em Tempo Real
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-6">Custo Total:</dt>
                            <dd class="col-sm-6 text-end" id="resultado_custo_total">R$ 0,00</dd>
                            
                            <dt class="col-sm-6">Imposto Venda (R$):</dt>
                            <dd class="col-sm-6 text-end" id="resultado_imposto_venda">R$ 0,00</dd>

                            <dt class="col-sm-6">Preço de Venda:</dt>
                            <dd class="col-sm-6 text-end fs-5 fw-bold text-primary" id="resultado_preco_venda">R$ 0,00</dd>
                            
                            <hr class="my-2">

                            <dt class="col-sm-6 fs-5">Lucro Líquido:</dt>
                            <dd class="col-sm-6 text-end fs-5 fw-bold text-success" id="resultado_lucro_liquido">R$ 0,00</dd>
                        </dl>
                        <div class="d-grid gap-2 mt-3">
                            <button type="button" class="btn btn-info" onclick="calcularPreco()">
                                <i class="bi bi-calculator me-1"></i> Calcular
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg">Salvar Produto</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    
    {% if produto and produto.preco_a_vista %}
    <div class="card mt-4">
        <div class="card-header">
            Simulação de Parcelamento (Baseado no Preço Salvo: {{ produto.preco_a_vista|currency }})
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm" id="parcelamento-table">
                    <thead>
                        <tr>
                            <th>Método</th>
                            <th class="text-end">Valor da Parcela</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                         {% for i in range(1, 13) %}
                            {% set metodo = i ~ "x" %}
                            {% if metodo in taxas_dict %}
                            <tr>
                                <td>{{ metodo }}</td>
                                {% set preco_parcelado = produto.preco_a_vista / taxas_dict[metodo].coeficiente %}
                                <td class="text-end">{{ (preco_parcelado / i)|currency }}</td>
                                <td class="text-end">{{ preco_parcelado|currency }}</td>
                            </tr>
                            {% endif %}
                         {% endfor %}
                    </tbody>
                </table>
            </div>
             <button type="button" onclick="copiarParaWhatsApp()" class="btn btn-success mt-3">
                <i class="bi bi-whatsapp me-1"></i> Copiar para WhatsApp
            </button>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/imask"></script>

    {% if produto and produto.preco_a_vista %}
    <script>
        function copiarParaWhatsApp() {
            const produtoNome = {{ produto.nome|tojson }};
            const precoAVista = {{ produto.preco_a_vista|float }};
            let whatsappText = `Simulação de Parcelamento\nM4 Tática\nProduto: ${produtoNome} Valor à Vista R$ ${precoAVista.toFixed(2).replace(".", ",")}\n\n`;
            const table = document.getElementById("parcelamento-table");
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const metodo = row.cells[0].innerText;
                const valorParcela = row.cells[1].innerText;
                const total = row.cells[2].innerText;
                if (metodo.toLowerCase().includes("pix") || metodo.toLowerCase().includes("débito")) {
                    whatsappText += `${metodo}: ${total}\n`;
                } else {
                    whatsappText += `${metodo}: ${valorParcela} = ${total}\n`;
                }
            }
            whatsappText += `\nOs valores poderão sofrer alterações sem aviso prévio`;
            navigator.clipboard.writeText(whatsappText).then(() => {
                alert("Texto copiado para a área de transferência!");
            }).catch(err => {
                console.error("Erro ao copiar texto: ", err);
            });
        }
    </script>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const allMasks = {};
            const currencyOptions = { mask: 'R$ num', blocks: { num: { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, radix: ',', mapToRadix: ['.'] } } };
            const percentageOptions = { mask: 'num %', blocks: { num: { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: false, radix: ',', mapToRadix: ['.'] } } };
            
            const inputsToMask = [
                { id: 'valor_fornecedor_real', options: currencyOptions },
                { id: 'desconto_fornecedor_percentual', options: percentageOptions },
                { id: 'frete_real', options: currencyOptions },
                { id: 'ipi_valor', options: {} }, // Máscara dinâmica
                { id: 'difal_percentual', options: percentageOptions },
                { id: 'imposto_venda_percentual', options: percentageOptions },
                { id: 'valor_metodo', options: {} } // Máscara dinâmica
            ];

            // Função para formatar valores existentes antes de aplicar a máscara
            function formatExistingValue(element, maskType) {
                const currentValue = element.value;
                if (!currentValue || currentValue === '' || currentValue === '0.0') return;
                
                const numericValue = parseFloat(currentValue.replace(',', '.'));
                if (isNaN(numericValue)) return;
                
                if (maskType === 'currency') {
                    element.value = numericValue.toFixed(2).replace('.', ',');
                } else if (maskType === 'percentage') {
                    element.value = numericValue.toFixed(2).replace('.', ',');
                }
            }

            inputsToMask.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    // Formatar valores existentes antes de aplicar a máscara
                    if (item.options === currencyOptions) {
                        formatExistingValue(element, 'currency');
                    } else if (item.options === percentageOptions) {
                        formatExistingValue(element, 'percentage');
                    }
                    
                    allMasks[item.id] = IMask(element, item.options);
                }
            });

            function updateDynamicMasks() {
                const ipiTipo = document.querySelector('input[name="ipi_tipo"]:checked').value;
                const metodoPrecificacao = document.querySelector('input[name="metodo_precificacao"]:checked').value;

                if (allMasks['ipi_valor']) allMasks['ipi_valor'].destroy();
                const ipiElement = document.getElementById('ipi_valor');
                if (ipiTipo === 'percentual') {
                    formatExistingValue(ipiElement, 'percentage');
                    allMasks['ipi_valor'] = IMask(ipiElement, percentageOptions);
                } else {
                    formatExistingValue(ipiElement, 'currency');
                    allMasks['ipi_valor'] = IMask(ipiElement, currencyOptions);
                }

                if (allMasks['valor_metodo']) allMasks['valor_metodo'].destroy();
                const metodoElement = document.getElementById('valor_metodo');
                if (metodoPrecificacao === 'margem') {
                    formatExistingValue(metodoElement, 'percentage');
                    allMasks['valor_metodo'] = IMask(metodoElement, percentageOptions);
                } else {
                    formatExistingValue(metodoElement, 'currency');
                    allMasks['valor_metodo'] = IMask(metodoElement, currencyOptions);
                }
            }
            
            document.querySelectorAll('input[name="ipi_tipo"], input[name="metodo_precificacao"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateDynamicMasks();
                    calcularPreco(); 
                });
            });
            updateDynamicMasks();

            const form = document.getElementById('precificador-form');
            form.addEventListener('input', calcularPreco);
            
            // Aguardar um pouco para garantir que as máscaras estejam totalmente inicializadas
            setTimeout(() => {
                // Calcula o preço inicial ao carregar a página se for uma edição
                if ({{ produto is not none|tojson }}) {
                    calcularPreco();
                }
            }, 100);
        });

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        }

        function calcularPreco() {
            const unmask = (id) => {
                const mask = allMasks[id];
                if (mask && mask.unmaskedValue) {
                    return parseFloat(mask.unmaskedValue);
                }
                const element = document.getElementById(id);
                return parseFloat(element.value.replace(',', '.')) || 0;
            };

            const valorFornecedor = unmask('valor_fornecedor_real');
            const desconto = unmask('desconto_fornecedor_percentual');
            const frete = unmask('frete_real');
            const difal = unmask('difal_percentual');
            const ipiTipo = document.querySelector('input[name="ipi_tipo"]:checked').value;
            const ipiValorForm = unmask('ipi_valor');
            const impostoVenda = unmask('imposto_venda_percentual');
            const metodoPrecificacao = document.querySelector('input[name="metodo_precificacao"]:checked').value;
            const valorMetodo = unmask('valor_metodo');

            const valorCompraDesconto = valorFornecedor * (1 - (desconto / 100));
            
            let valorIpi = 0;
            if (ipiTipo === 'percentual' && ipiValorForm > 0) {
                valorIpi = valorCompraDesconto - (valorCompraDesconto / (1 + (ipiValorForm / 100)));
            } else {
                valorIpi = ipiValorForm;
            }

            const baseCalculoDifal = (valorCompraDesconto - valorIpi) + frete;
            const valorDifal = baseCalculoDifal * (difal / 100);
            
            const custoTotal = valorCompraDesconto + frete + valorDifal;

            let precoVenda = 0;
            if (metodoPrecificacao === 'margem') {
                const denominador = (1 - (impostoVenda / 100) - (valorMetodo / 100));
                if (denominador > 0) precoVenda = custoTotal / denominador;
            } else if (metodoPrecificacao === 'lucro_alvo') {
                const denominador = (1 - (impostoVenda / 100));
                if (denominador > 0) precoVenda = (custoTotal + valorMetodo) / denominador;
            } else if (metodoPrecificacao === 'preco_final') {
                precoVenda = valorMetodo;
            }

            const valorImpostoVenda = precoVenda * (impostoVenda / 100);
            const lucroLiquido = precoVenda - custoTotal - valorImpostoVenda;
            
            document.getElementById('resultado_custo_total').innerText = formatCurrency(custoTotal);
            document.getElementById('resultado_imposto_venda').innerText = formatCurrency(valorImpostoVenda);
            document.getElementById('resultado_preco_venda').innerText = formatCurrency(precoVenda);
            document.getElementById('resultado_lucro_liquido').innerText = formatCurrency(lucroLiquido);
        }
    </script>
{% endblock %}